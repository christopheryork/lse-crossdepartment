<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

text {
  stroke: none;
}

</style>
<body>
<script src="js/d3.min.js"></script>
<script src="js/queue.min.js"></script>
<script>

function empty_matrix(n) {
  var m = Array(n)
  var i = -1; while(i++ < n) {
    m[i] = Array(n)
    var j = -1; while(j++ < n) {
      m[i][j] = 0.0
    }
  }
  return m
}

function trim(d, n) {
  return (d.length > n) ? (d.slice(0,n-3)+"...") : d
}

queue().defer(d3.csv, "data-6.2.csv")
       .defer(d3.csv, "data-6.4.csv")
       .await( (err, research, teaching) => {
  if(err) { throw err }

  // convert data from JSON to javascript types
  research.forEach( (d) => d.links = +d.links )
  teaching.forEach( (d) => d.links = +d.links )

  // prepare list of nodes; should be a superset of depts list
  var rd1 = research.map( (d) => d.department1 )
  var rd2 = research.map( (d) => d.department2 )
  var td1 = teaching.map( (d) => d.department1 )
  var td2 = teaching.map( (d) => d.department2 )
  var dept_names = d3.set([].concat(rd1).concat(rd2).concat(td1).concat(td2)).values()
  dept_names.sort()
  var n = dept_names.length

  // prepare the matrices

  function populate(xs, m) {
    xs.forEach( (x) => {
      var i = dept_names.indexOf(x.department1)
      var j = dept_names.indexOf(x.department2)
      m[i][j] = m[j][i] = x.links
    })
    return m
  }

  var research_matrix = populate(research, empty_matrix(n))
  var teaching_matrix = populate(teaching, empty_matrix(n))

  // visualization proper

  var width = 1000,
      height = 600,
      padding = 150,
      cell_padding = 3,
      trim_value = 25;

  var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")

  svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .attr("fill", "black")

  var x_scale = d3.scale.ordinal()
    .domain(d3.range(n))
    .rangeRoundBands([0, width - padding], 0.1)

  var y_scale = d3.scale.ordinal()
    .domain(d3.range(n))
    .rangeRoundBands([0, height - padding], 0.1)

  var size = (i,j) => research_matrix[i][j] + teaching_matrix[i][j]
  var bal = (i,j) => research_matrix[i][j] - teaching_matrix[i][j]

  var matrix = svg.append("g")
      .attr("class", "matrix");

  var points = d3.merge(d3.range(n).map( (i) => d3.range(n).map( (j) => {
    return { i: i, j: j}
  })))

  var g = matrix
    .selectAll("g")
      .data(points)
    .enter()
      .append("g")
        .attr("transform", (d) => "translate(" + x_scale(d.i) + "," + (padding + y_scale(d.j)) + ")" )
        .attr("opacity", (d) => (d.i > d.j) ? "1.0" : "0.5" )

  g.append("title")
    .text((d) => dept_names[d.i] + " & " + dept_names[d.j] +
               "\nResearch: " + research_matrix[d.i][d.j] +
               ", Teaching: " + teaching_matrix[d.i][d.j])

  // dots for linkages

  var rect = g.selectAll("rect")
    .data( (d) => d3.range(size(d.i, d.j)).map( (k) => d ) )

  rect.enter()
    .append("rect")
    .attr("width", 2)
    .attr("height", y_scale.rangeBand() - cell_padding)
    .attr("x", (d,i) => i * ((x_scale.rangeBand() - cell_padding) / 10.0 + 1.0))
    .attr("fill", (d, i) => {
      var s = size(d.i, d.j)
      var b = bal(d.i, d.j)
      return (i < s - Math.abs(b)) ? "gray" : (b > 0) ? "#f16913" : "#08519c"
    })

  // Rules

  svg.append("g")
    .attr("class", "x_labels")
    .attr("transform", "translate(0," + padding + ")")
   .selectAll("text")
    .data(dept_names)
   .enter().append("g")
    .attr("transform", (d, i) => "translate(" + (x_scale(i) + 5) + ",-5)rotate(-90)")
   .append("text")
    .attr("class", (d, i) => "dept" + i)
    .attr("dominant-baseline", "middle")
    .text( (d) => trim(d, trim_value) )
    .attr("fill", "white")

  svg.append("g")
    .attr("class", "y_labels")
    .attr("transform", "translate(" + (width - padding) + ",0)")
   .selectAll("text")
    .data(dept_names)
   .enter().append("text")
    .attr("class", (d,i) => "dept" + i)
    .attr("y", (d,i) => padding + y_scale(i))
    .attr("dy",  y_scale.rangeBand() / 2.0)
    .attr("dominant-baseline", "middle")
    .text( (d) => trim(d, 20) )
    .attr("fill", "white")
})

</script>